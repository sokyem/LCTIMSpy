# LCTIMSpy
## About
LCTIMSpy is a Python package for processing and analyzing TIMSTOF LC-TIMS-MS data obtained by using conventional methods or by a custom CID_tims workflow. It contains modified functions from the pyTDFSDK package and other custom functions for easy plotting of chromatograms and mobilograms from multiple LC-IMS-MS runs. It includes functions for:
- Extracting LC-TIMS-MS data from a TDF object. 
- Plotting chromatograms interactively with Plotly and with Matplotlib. 
- Calculating fragment and precursor m/z values for a peptide sequence.
- Extracting and Plotting chromatograms and mobilograms of fragment ions generated by the CID_tims workflow.
- Calculating mobility difference at different retention times for the same m/z value. 
- Processing and plotting multiple TIMSTOF LC-TIMS-MS data simultaneously. 

## Installation 
You can install the package via pip (from GitHub):

```bash
pip install git+https://github.com/sokyem/LCTIMSpy.git
```
# Usage 
- Extract LC-TIMS-MS data from  a bruker .d folder
- Extract chromatograms and mobilograms for peptide fragments in a CID-TIMS wrokflow
- Plot interactive and custom chromatograms and mobilograms 
- Calculate the difference in mobility for peptides eluting at multiple retention time
``` Python
from pyTDFSDK.init_tdf_sdk import init_tdf_sdk_api
from pyTDFSDK import *
from CID_tims_analysis import *
from pyTDFSDK.ctypes_data_structures import PressureCompensationStrategy

#Initialize TDF-SDK library using the packaged .dll or .so files for Windows or Linux.

dll = init_tdf_sdk_api()

#Single LC-TIMS-Data Processing
# Initialize TdfData object

Tdf_obj = TdfData(
        bruker_d_folder_name=path_to_bruker_d_folder,
        tdf_sdk=dll,
        pressure_compensation_strategy=PressureCompensationStrategy.PerFramePressureCompensation,
        sql_chunksize=500)
        
# extract LC-TIMS-MS data from the TDF_object

lc_tims_ms_df = extract_lcms_tdf_data(
        tdf_data=Tdf_obj,
        mode='profile', profile_bins=0.01,
        chunk_size=chunk_size, mobility_bin_width=0.0005
    )

#Process multiple .d data 
# Initialize TdfData objects for each file.
tdf_data_dict = {
    sample_id: TdfData(
        bruker_d_folder_name=path_to_bruker_d_folders,
        tdf_sdk=dll,
        pressure_compensation_strategy=PressureCompensationStrategy.PerFramePressureCompensation,
        sql_chunksize=500
    )
    for sample_id, path in paths.items() #paths is a dictionary of a directory to bruker .d folder. 
}

# Extract LCâ€“MS data from each TdfData object.
lcms_data_dict = {}
for sample_id, tdf_obj in tdf_data_dict.items():
    lcms_data_dict[sample_id] = extract_lcms_tdf_data(
        tdf_data=tdf_obj,
        mode='profile', profile_bins=0.01,
        chunk_size=chunk_size, mobility_bin_width=0.0005 #bin mobility based on requirement
    )

#Ploting and Visualizing
#plot chromatograms and savefigs 
plot_chromatograms(df=lc_tims_ms_df, smooth_method='savgol', smooth_points=3,
                               mz_tolerance= 0.02, major_ticks=2, minor_ticks=0.5,
                               target_mzs=None, savefig_path=None,
                               retention_time_range=None)
#plot interactive chromatograms: allows zooming 

plot_chromatograms(df=lc_tims_ms_df, smooth_method='savgol', smooth_points=3,
                               mz_tolerance=0.02, major_ticks=2, minor_ticks=0.5,
                               target_mzs=None,
                               retention_time_range=None)


#plot mobilograms for multiple target m/z values at a specified retention time range
# For example for a CID-TIMS workflow you can process all mobilograms of coeluting fragment ions at different retention time and inspect if there is a difference in mobility for the fragment ions. 

process_mobilogram_interactive_plots(lcms_data_dict=lcms_data_dict, 
                                     target_mzs=fragment_mz, 
                                     rt_ranges=[(29.8, 30.4), (31.5, 32)],
                                     normalize=True,
                                     mz_tolerance=0.02, apply_smoothing=True, sigma=0.5, overlay=True)

# calculate the difference in mobility for a specified m/z value at different retention times

mob_diff_for_mz = extract_and_calculate_mobility_difference(df=lc_tims_ms_df,
                                          target_mzs=target_mz, 
                                          rt_ranges=[(29.8, 30.4), (31.5, 32.0)], 
                                        intensity_threshold=100,
                                        mz_tolerance=0.02, apply_smoothing=False, sigma=0.5)
                                        





                               


